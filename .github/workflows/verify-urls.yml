# .github/workflows/verify-urls.yml

name: Verificación diaria de URLs de eventos

on:
  # Ejecuta el workflow cada día a las 5:00 AM UTC (7:00 AM en España)
  schedule:
    - cron: '0 5 * * *'
  # Permite ejecutar este workflow manualmente desde la pestaña "Actions" de GitHub
  workflow_dispatch:

jobs:
  verify-urls:
    runs-on: ubuntu-latest
    
    # Establece el directorio de trabajo para todos los comandos 'run' de este job
    defaults:
      run:
        working-directory: ./apps/api

    steps:
      # 1. Obtiene el código del repositorio
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Configura Node.js y activa el caché de dependencias
      - name: Set up Node.js v20 with dependency caching
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          # CAMBIO CLAVE: Usamos un patrón glob para que encuentre el archivo
          # en cualquier subdirectorio, lo que es ideal para nuestro monorepo.
          cache-dependency-path: '**/package-lock.json'

      # 3. Instala las dependencias
      - name: Install dependencies
        run: npm install

      # 4. Ejecuta el script de verificación
      - name: Run URL verification script
        run: node verify-event-urls.js
        env:
          # Asegúrate de que el Secret en GitHub se llame 'MONGODB_URI'
          MONGODB_URI: ${{ secrets.MONGO_URI }}

      # 5. Notificar en caso de fallo
      - name: Notify on failure
        if: failure()
        run: echo "🔴 ¡El workflow de verificación de URLs ha fallado!"